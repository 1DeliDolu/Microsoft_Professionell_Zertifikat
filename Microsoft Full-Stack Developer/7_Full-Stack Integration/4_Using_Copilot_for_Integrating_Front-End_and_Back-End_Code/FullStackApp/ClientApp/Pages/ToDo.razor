@page "/todo"
@using System.Net.Http.Json
@using System.Text.Json
@inject IHttpClientFactory HttpClientFactory
@inject IJSRuntime JS

<PageTitle>Todo</PageTitle>

<h3 class="mb-3">Todo by Category</h3>

@if (!string.IsNullOrWhiteSpace(error))
{
    <div class="alert alert-danger" role="alert">@error</div>
}

<div class="row g-3">
    <!-- LEFT: Categories -->
    <div class="col-12 col-lg-4">
        <div class="card shadow-sm">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <span class="fw-semibold">Categories</span>
                <span class="badge text-bg-light">@categories.Count</span>
            </div>

            <div class="card-body">
                <form id="categoryForm" novalidate @onsubmit="AddCategory" @onsubmit:preventDefault="true">
                    <div class="input-group mb-3">
                        <span class="input-group-text">
                            <i class="bi bi-folder-plus" aria-hidden="true"></i>
                        </span>
                        <input id="newCategoryName"
                               class="form-control"
                               placeholder="New category..."
                               @bind="newCategoryName"
                               @bind:event="oninput"
                               required />
                        <button class="btn btn-primary" type="submit">Add</button>
                        <div class="invalid-feedback">Category name cannot be empty.</div>
                    </div>
                </form>

                @if (categories.Count == 0)
                {
                    <div class="alert alert-secondary mb-0" role="alert">No categories yet.</div>
                }
                else
                {
                    <div class="d-grid gap-2">
                        @foreach (var c in categories)
                        {
                            var bg = GetCategoryBg(c.Id);

                            <div class="d-flex gap-2 align-items-stretch">
                                <button type="button"
                                        class="btn text-start flex-grow-1 @bg @(selectedCategoryId == c.Id ? "border border-dark" : "")"
                                        @onclick="() => SelectCategory(c.Id)">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="fw-semibold">@c.Name</span>
                                        <span class="badge text-bg-dark">@TodoCount(c.Id)</span>
                                    </div>
                                </button>

                                <button type="button"
                                        class="btn btn-sm btn-outline-danger"
                                        title="Delete category"
                                        @onclick="() => DeleteCategory(c)">
                                    <i class="bi bi-trash" aria-hidden="true"></i>
                                </button>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- RIGHT: Todos -->
    <div class="col-12 col-lg-8">
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <span class="fw-semibold">Recent Todos (Top 5)</span>
                <span class="badge text-bg-light">@Math.Min(5, allTodos.Count) / @allTodos.Count</span>
            </div>

            <div class="card-body p-0">
                @{
                    var recent = RecentTodos.ToList();
                }

                @if (recent.Count == 0)
                {
                    <div class="p-3">
                        <div class="alert alert-secondary mb-0" role="alert">No todos yet.</div>
                    </div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width:80px;">Done</th>
                                    <th>Title</th>
                                    <th style="width:180px;">Category</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var t in recent)
                                {
                                    <tr>
                                        <td>
                                            @if (t.IsDone)
                                            {
                                                <span class="badge text-bg-success">Done</span>
                                            }
                                            else
                                            {
                                                <span class="badge text-bg-secondary">Open</span>
                                            }
                                        </td>
                                        <td>
                                            <span class="@(t.IsDone ? "text-decoration-line-through text-muted" : "")">@t.Title</span>
                                        </td>
                                        <td>
                                            <span class="badge text-bg-dark">
                                                @(categories.FirstOrDefault(c => c.Id == t.CategoryId)?.Name ?? $"#{t.CategoryId}")
                                            </span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center @(selectedCategoryId is null ? "bg-dark text-white" : GetCategoryBg((int)selectedCategoryId!))">
                <span class="fw-semibold">
                    @if (selectedCategoryId is null)
                    {
                        <text>Select a category</text>
                    }
                    else
                    {
                        <text>Todos — @SelectedCategoryName</text>
                    }
                </span>
                <span class="badge text-bg-dark">@todos.Count</span>
            </div>

            <div class="card-body">
                @if (selectedCategoryId is null)
                {
                    <div class="alert alert-secondary mb-0" role="alert">
                        Create a category and select it to add todos.
                    </div>
                }
                else
                {
                    <form id="todoForm" novalidate class="mb-3" @onsubmit="AddTodo" @onsubmit:preventDefault="true">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-check2-square" aria-hidden="true"></i>
                            </span>

                            <input id="newTodoTitle"
                                   class="form-control"
                                   placeholder="New todo..."
                                   @bind="newTodoTitle"
                                   @bind:event="oninput"
                                   required />
                            <button class="btn btn-primary" type="submit">Add</button>
                            <div class="invalid-feedback">Todo title cannot be empty.</div>
                        </div>
                    </form>

                    @if (todos.Count == 0)
                    {
                        <div class="alert alert-secondary mb-0" role="alert">No todos in this category.</div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width:70px;">Done</th>
                                        <th>Title</th>
                                        <th class="text-end" style="width:200px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var t in todos)
                                    {
                                        <tr>
                                            <td>
                                                <input class="form-check-input"
                                                       type="checkbox"
                                                       checked="@t.IsDone"
                                                       @onchange="(e) => ToggleDone(t, (bool)e.Value!)" />
                                            </td>

                                            <td>
                                                @if (editTodoId == t.Id)
                                                {
                                                    <input id="@EditInputId(t.Id)"
                                                           class="form-control"
                                                           @bind="editTodoTitle"
                                                           @bind:event="oninput"
                                                           required />
                                                    <div class="invalid-feedback">Title cannot be empty.</div>
                                                }
                                                else
                                                {
                                                    <span class="@(t.IsDone ? "text-decoration-line-through text-muted" : "")">
                                                        @t.Title
                                                    </span>
                                                }
                                            </td>

                                            <td class="text-end">
                                                @if (editTodoId == t.Id)
                                                {
                                                    <button type="button" class="btn btn-sm btn-success me-2" @onclick="() => SaveEdit(t)">Save</button>
                                                    <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="CancelEdit">Cancel</button>
                                                }
                                                else
                                                {
                                                    <button type="button" class="btn btn-sm btn-outline-primary me-2" @onclick="() => StartEdit(t)">Edit</button>
                                                    <button type="button" class="btn btn-sm btn-outline-danger" @onclick="() => DeleteTodo(t)">Delete</button>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>

@code {
    private HttpClient Api => HttpClientFactory.CreateClient("ServerAPI");

    private string? error;

    private List<TodoCategory> categories = new();
    private List<TodoItem> todos = new();
    private List<TodoItem> allTodos = new();
    private IEnumerable<TodoItem> RecentTodos => allTodos.Take(5);

    private string newCategoryName = "";
    private int? selectedCategoryId;

    private string newTodoTitle = "";

    private int? editTodoId;
    private string editTodoTitle = "";

    private string SelectedCategoryName =>
        selectedCategoryId is null
            ? ""
            : categories.FirstOrDefault(c => c.Id == selectedCategoryId)?.Name ?? "";

    protected override async Task OnInitializedAsync()
    {
        await LoadCategories();
        await LoadAllTodos();
    }

    private async Task LoadCategories()
    {
        error = null;
        try
        {
            var data = await Api.GetFromJsonAsync<List<TodoCategory>>("api/todo-categories");
            categories = data ?? new List<TodoCategory>();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }

    private async Task LoadAllTodos()
    {
        error = null;
        try
        {
            var data = await Api.GetFromJsonAsync<List<TodoItem>>("api/todos");
            allTodos = data ?? new List<TodoItem>();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }

    private async Task SelectCategory(int id)
    {
        selectedCategoryId = id;
        await LoadTodos(id);
    }

    private async Task LoadTodos(int categoryId)
    {
        error = null;
        editTodoId = null;
        editTodoTitle = "";

        try
        {
            var data = await Api.GetFromJsonAsync<List<TodoItem>>($"api/todos?categoryId={categoryId}");
            todos = data ?? new List<TodoItem>();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }

    private int TodoCount(int categoryId)
        => allTodos.Count(t => t.CategoryId == categoryId);

    private async Task AddCategory()
    {
        error = null;

        var ok = await JS.InvokeAsync<bool>("todoForms.validateRequiredTrimmed", "newCategoryName");
        if (!ok) return;

        var name = newCategoryName.Trim();

        try
        {
            var resp = await Api.PostAsJsonAsync("api/todo-categories", new { Name = name });
            if (!resp.IsSuccessStatusCode)
            {
                error = await resp.Content.ReadAsStringAsync();
                return;
            }

            var created = await resp.Content.ReadFromJsonAsync<TodoCategory>(
                new JsonSerializerOptions { PropertyNameCaseInsensitive = true });

            if (created is not null)
            {
                categories.Insert(0, created);
                newCategoryName = "";
                await JS.InvokeVoidAsync("todoForms.clearValidation", "newCategoryName");
            }
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }

    private async Task DeleteCategory(TodoCategory c)
    {
        error = null;

        var ok = await JS.InvokeAsync<bool>("confirm", $"Delete category '{c.Name}'? (It must have no todos.)");
        if (!ok) return;

        try
        {
            var resp = await Api.DeleteAsync($"api/todo-categories/{c.Id}");

            if (resp.IsSuccessStatusCode)
            {
                categories.RemoveAll(x => x.Id == c.Id);

                if (selectedCategoryId == c.Id)
                {
                    selectedCategoryId = null;
                    todos.Clear();
                    CancelEdit();
                }

                return;
            }

            if ((int)resp.StatusCode == 409)
            {
                var msg = await resp.Content.ReadAsStringAsync();
                error = string.IsNullOrWhiteSpace(msg)
                    ? "Category has todos. Delete todos first."
                    : msg;
                return;
            }

            error = await resp.Content.ReadAsStringAsync();
            if (string.IsNullOrWhiteSpace(error))
                error = $"Delete failed: {(int)resp.StatusCode}";
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }

    private async Task AddTodo()
    {
        error = null;

        if (selectedCategoryId is null)
        {
            error = "Select a category first.";
            return;
        }

        var ok = await JS.InvokeAsync<bool>("todoForms.validateRequiredTrimmed", "newTodoTitle");
        if (!ok) return;

        var title = newTodoTitle.Trim();

        try
        {
            var resp = await Api.PostAsJsonAsync("api/todos", new { CategoryId = selectedCategoryId.Value, Title = title });
            if (!resp.IsSuccessStatusCode)
            {
                error = await resp.Content.ReadAsStringAsync();
                return;
            }

            var created = await resp.Content.ReadFromJsonAsync<TodoItem>(
                new JsonSerializerOptions { PropertyNameCaseInsensitive = true });

            if (created is not null)
            {
                todos.Insert(0, created);
                allTodos.Insert(0, created);

                newTodoTitle = "";
                await JS.InvokeVoidAsync("todoForms.clearValidation", "newTodoTitle");
            }
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }

    private void StartEdit(TodoItem t)
    {
        editTodoId = t.Id;
        editTodoTitle = t.Title;
    }

    private void CancelEdit()
    {
        editTodoId = null;
        editTodoTitle = "";
    }

    private async Task SaveEdit(TodoItem t)
    {
        error = null;

        var ok = await JS.InvokeAsync<bool>("todoForms.validateRequiredTrimmed", EditInputId(t.Id));
        if (!ok) return;

        var title = editTodoTitle.Trim();

        try
        {
            var resp = await Api.PutAsJsonAsync($"api/todos/{t.Id}", new { Title = title, IsDone = t.IsDone });
            if (!resp.IsSuccessStatusCode)
            {
                error = await resp.Content.ReadAsStringAsync();
                return;
            }

            var updated = await resp.Content.ReadFromJsonAsync<TodoItem>(
                new JsonSerializerOptions { PropertyNameCaseInsensitive = true });

            if (updated is not null)
            {
                var idx = todos.FindIndex(x => x.Id == t.Id);
                if (idx >= 0) todos[idx] = updated;
                var aidx = allTodos.FindIndex(x => x.Id == t.Id);
                if (aidx >= 0) allTodos[aidx] = updated;
                CancelEdit();
            }
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }

    private async Task ToggleDone(TodoItem t, bool isDone)
    {
        error = null;

        try
        {
            var resp = await Api.PutAsJsonAsync($"api/todos/{t.Id}", new { Title = t.Title, IsDone = isDone });
            if (!resp.IsSuccessStatusCode)
            {
                error = await resp.Content.ReadAsStringAsync();
                return;
            }

            var updated = await resp.Content.ReadFromJsonAsync<TodoItem>(
                new JsonSerializerOptions { PropertyNameCaseInsensitive = true });

            if (updated is not null)
            {
                var idx = todos.FindIndex(x => x.Id == t.Id);
                if (idx >= 0) todos[idx] = updated;
                var aidx = allTodos.FindIndex(x => x.Id == t.Id);
                if (aidx >= 0) allTodos[aidx] = updated;
            }
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }

    private async Task DeleteTodo(TodoItem t)
    {
        error = null;

        try
        {
            var resp = await Api.DeleteAsync($"api/todos/{t.Id}");
            if (!resp.IsSuccessStatusCode && resp.StatusCode != System.Net.HttpStatusCode.NotFound)
            {
                error = await resp.Content.ReadAsStringAsync();
                return;
            }

            todos.RemoveAll(x => x.Id == t.Id);
            allTodos.RemoveAll(x => x.Id == t.Id);
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }

    private static string EditInputId(int id) => $"editTodoTitle_{id}";

    private static string GetCategoryBg(int categoryId)
    {
        // Bootstrap “subtle” backgrounds; rotate by id
        var styles = new[]
        {
            "bg-primary-subtle",
            "bg-success-subtle",
            "bg-warning-subtle",
            "bg-info-subtle",
            "bg-danger-subtle",
            "bg-secondary-subtle"
        };

        return styles[Math.Abs(categoryId) % styles.Length];
    }

    public sealed class TodoCategory
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public DateTimeOffset CreatedAt { get; set; }
    }

    public sealed class TodoItem
    {
        public int Id { get; set; }
        public int CategoryId { get; set; }
        public string Title { get; set; } = "";
        public bool IsDone { get; set; }
        public DateTimeOffset CreatedAt { get; set; }
    }
}
