@page "/register"
@using System.ComponentModel.DataAnnotations

<h3>Register</h3>

<EditForm Model="model" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label class="form-label">Email address</label>
        <InputText @bind-Value="model.Email" class="form-control" />
        <ValidationMessage For="() => model.Email" />
        <div class="form-text">We'll never share your email with anyone else.</div>
    </div>

    <div class="mb-3">
        <label class="form-label">Username</label>
        <InputText @bind-Value="model.Username" class="form-control" pattern="[a-zA-Z0-9]{4,12}"
            title="Must be 4-12 characters long and alphanumeric" />
        <ValidationMessage For="() => model.Username" />
    </div>

    <div class="mb-3">
        <label class="form-label">Password</label>

        <div class="input-group">
            <InputText @bind-Value="model.Password" type="@PasswordInputType" class="form-control"
                autocomplete="new-password" />

            <button type="button" class="btn btn-outline-secondary" @onclick="TogglePassword"
                aria-label="Show/Hide password">
                <i class="@PasswordEyeIconClass"></i>
            </button>
        </div>

        <ValidationMessage For="() => model.Password" />
        <div class="form-text">Minimum 10 characters, upper & lower case, digit and special character.</div>
    </div>

    <div class="mb-3">
        <label class="form-label">Confirm Password</label>

        <div class="input-group">
            <InputText @bind-Value="model.ConfirmPassword" type="@ConfirmPasswordInputType" class="form-control"
                autocomplete="new-password" />

            <button type="button" class="btn btn-outline-secondary" @onclick="ToggleConfirmPassword"
                aria-label="Show/Hide confirm password">
                <i class="@ConfirmPasswordEyeIconClass"></i>
            </button>
        </div>

        <ValidationMessage For="() => model.ConfirmPassword" />
    </div>

    <button class="btn btn-primary" disabled="@isSubmitting">@((isSubmitting) ? "Registering..." : "Register")</button>

    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <div class="mt-3 alert @statusClass" role="alert">@statusMessage</div>
    }
</EditForm>

@code {
    private RegisterModel model = new();
    private bool isSubmitting = false;
    private string statusMessage = string.Empty;
    private string statusClass = "";

    // Toggle state'leri
    private bool showPassword = false;
    private bool showConfirmPassword = false;

    private string PasswordInputType => showPassword ? "text" : "password";
    private string ConfirmPasswordInputType => showConfirmPassword ? "text" : "password";

    private string PasswordEyeIconClass => showPassword ? "bi bi-eye-slash" : "bi bi-eye";
    private string ConfirmPasswordEyeIconClass => showConfirmPassword ? "bi bi-eye-slash" : "bi bi-eye";

    private void TogglePassword() => showPassword = !showPassword;
    private void ToggleConfirmPassword() => showConfirmPassword = !showConfirmPassword;

    private async Task HandleValidSubmit()
    {
        // Double-check passwords match (server-side validation already enforces this via Compare)
        if (model.Password != model.ConfirmPassword)
        {
            statusMessage = "Passwords do not match.";
            statusClass = "alert-danger";
            return;
        }

        isSubmitting = true;
        statusMessage = string.Empty;
        statusClass = string.Empty;

        try
        {
            // TODO: integrate with ASP.NET Identity service or API here.
            await Task.Delay(300); // simulate async work

            statusMessage = "Registration successful (demo). You can now log in.";
            statusClass = "alert-success";
            model = new RegisterModel(); // reset form

            // form reset sonrası görünürlükleri de sıfırla
            showPassword = false;
            showConfirmPassword = false;
        }
        catch (Exception ex)
        {
            statusMessage = "Registration failed: " + ex.Message;
            statusClass = "alert-danger";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    public class RegisterModel : IValidatableObject
    {
        [Required(ErrorMessage = "Username is required")]
        [RegularExpression("^[a-zA-Z0-9]{4,12}$", ErrorMessage = "Username must be 4-12 alphanumeric characters")]
        public string Username { get; set; } = string.Empty;

        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Invalid email address")]
        public string Email { get; set; } = string.Empty;

        [Required(ErrorMessage = "Password is required")]
        [StringLength(100, MinimumLength = 10, ErrorMessage = "Password must be at least 10 characters")]
        public string Password { get; set; } = string.Empty;

        [Required(ErrorMessage = "Confirm password is required")]
        [Compare("Password", ErrorMessage = "Passwords do not match")]
        public string ConfirmPassword { get; set; } = string.Empty;

        public IEnumerable<ValidationResult> Validate(ValidationContext validationContext)
        {
            var results = new List<ValidationResult>();

            if (!string.IsNullOrEmpty(Password))
            {
                if (!Password.Any(char.IsUpper))
                    results.Add(new ValidationResult("Password must contain at least one uppercase letter.", new[] { nameof(Password) }));
                if (!Password.Any(char.IsLower))
                    results.Add(new ValidationResult("Password must contain at least one lowercase letter.", new[] { nameof(Password) }));
                if (!Password.Any(char.IsDigit))
                    results.Add(new ValidationResult("Password must contain at least one digit.", new[] { nameof(Password) }));
                if (!Password.Any(ch => !char.IsLetterOrDigit(ch)))
                    results.Add(new ValidationResult("Password must contain at least one special character.", new[] { nameof(Password) }));
            }

            return results;
        }
    }
}